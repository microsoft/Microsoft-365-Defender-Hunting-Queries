// These queries check telemetry from the Exploit Guard rule: Rule: Block Office applications from creating child processes
// (Rule ID d4f940ab-401b-4efc-aadc-ad5f3c50688a)
// Read more about it here: https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-exploit-guard/attack-surface-reduction-exploit-guard
// Oftentimes organizations enable this rule in audit mode and check the results before setting block mode.
// You can use query #2 to measure the rule impact on your network in audit mode before turning it to block mode.
// Query #1 is used after setting it to block mode - to analyze the block stats.
// Tags: #ExploitGuard

//Query #1: block stats
MiscEvents
| where ActionType == "ExploitGuardASRBlocked" and EventTime > ago(7d)
| project BlockedProcess=FileName, ParentProcess=InitiatingProcessFileName, ComputerName,
          RuleId=tostring(parsejson(AdditionalFields).RuleId)
| where RuleId == "d4f940ab-401b-4efc-aadc-ad5f3c50688a"
| summarize MachineCount=dcount(ComputerName), RuleHits=count() by BlockedProcess, ParentProcess
| sort by MachineCount desc

// Query #2: investigate audit events - before turning the rule on in block mode
let minTime = ago(7d);
// Enrich the ExploitGuard events with column saying if there was a nearby Windows Defender ATP alert or not.
// If there was an alert, so this is probably malware, and it's good that it will be blocked.
// If there was no alert, so it requires further analysis to determine if this is a clean file or some malware that was missed.
let alerts =
    AlertEvents
    | where EventTime > minTime
    | project ComputerName, DetectedEventTime=EventTime;
MiscEvents
| where ActionType == "ExploitGuardASRAudited" and EventTime > minTime
| project BlockedProcess=FileName, ParentProcess=InitiatingProcessFileName, ComputerName, EventTime,
          RuleId=tostring(parsejson(AdditionalFields).RuleId)
| where RuleId == "d4f940ab-401b-4efc-aadc-ad5f3c50688a"
| join kind=leftouter (alerts) on ComputerName
| extend HasNearbyAlert = abs(EventTime - DetectedEventTime) between (0min .. 5min)
| summarize MachineCount=dcount(ComputerName),
            RuleHits=count(),
            NearbyAlertPercent=countif(HasNearbyAlert)*100.0 / count() 
            by BlockedProcess, ParentProcess
| sort by MachineCount desc
